name: DCU Python CI Action
description: Perform basic python integration actions.
runs:
  using: "composite"
  steps:
    - shell: bash
      run: |
        cat > ~/.aws/credentials <<
        [CICD]
        aws_access_key_id=${{ secrets.AWS_ACCESS_KEY_ID_CICD }}
        aws_secret_access_key=${{ secrets.AWS_SECRET_ACCESS_KEY_CICD }}
        role_arn=${{ secrets.AWS_DEPLOY_ROLE_CICD }}
        duration_seconds=900

        EOF
        cat > ~/.aws/config <<
        [CICD]
        region=us-west-2
        output=json

        EOF
    - shell: bash
      run: |
        export AWS_PROFILE=CICD
        aws ecr get-login-password --region us-west-2 | docker login --username AWS --password-stdin 764525110978.dkr.ecr.us-west-2.amazonaws.com
    - shell: bash
      run: |
        git clone https://${{ secrets.REPO_PAT }}:x-oauth-basic@github.com/gdcorp-actions/tartufo.git .tartufo
        INPUT_GITHUB_TOKEN=${{ secrets.REPO_PAT }} python entrypoint.py
    - shell: bash
      run: |
        mkdir -p ~/.pip/
        echo "[global]" > ~/.pip/pip.conf
        echo "index-url = https://ci_ro_infosec-dcu:${{ secrets.DCU_ARTIFACTORY_RO_SVC_USER }}@artifactory.secureserver.net/artifactory/api/pypi/python-virt/simple" >> ~/.pip/pip.conf
        python -m venv .venv && source .venv/bin/activate
        pip install -r tools.txt -r requirements.txt
        flake8 .
        nosetests test/
